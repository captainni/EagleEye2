import{d as D,k as V,o as C,c as M,t as P,n as q,r as _,q as ee,p as te,f as E,w as a,e as t,a as m,b as A,m as U,i as X,I as H,g as F,E as T,s as G,j as le,B as Z,F as ie,y as ce}from"./index-095c05da.js";import{f as ue}from"./format-66ee9ebe.js";import{a as z}from"./request-203a8186.js";import{_ as K,N as de}from"./axios-c1489369.js";const oe=D({__name:"TypeTag",props:{type:{}},setup(i){const n=i,o=V(()=>{var r;const l=((r=n.type)==null?void 0:r.toLowerCase())||"";return l.includes("policy")||l==="new_source"?"bg-blue-100 text-blue-600":l.includes("competitor")?"bg-purple-100 text-purple-600":l.includes("error")||l.includes("config")?"bg-orange-100 text-orange-600":"bg-gray-100 text-gray-600"}),c=V(()=>{var r;const l=((r=n.type)==null?void 0:r.toLowerCase())||"";return l.includes("policy")||l==="new_source"?"政策来源":l.includes("competitor")?"竞品来源":l.includes("error")?"配置错误":l.includes("config")?"配置建议":n.type||"未知"});return(l,r)=>(C(),M("span",{class:q([o.value,"px-2 py-1 text-xs rounded-full whitespace-nowrap"])},P(c.value),3))}}),pe=D({__name:"StrategyTypeTag",props:{type:{}},setup(i){const n=i,o=V(()=>{switch(n.type){case"css":return"bg-green-100 text-green-600";case"llm":return"bg-indigo-100 text-indigo-600";case"none":return"bg-gray-100 text-gray-600";default:return"bg-gray-100 text-gray-600"}}),c=V(()=>{switch(n.type){case"css":return"CSS";case"llm":return"LLM";case"none":return"仅抓取";default:return"未知"}});return(l,r)=>(C(),M("span",{class:q([o.value,"px-2 py-1 text-xs rounded-full"])},P(c.value),3))}}),ge={class:"bg-white rounded-lg shadow-sm overflow-x-auto"},me={class:"font-medium"},fe={class:"space-x-1 whitespace-nowrap"},ve=D({__name:"ConfigTable",props:{configs:{type:Array,required:!0},loading:{type:Boolean,default:!1}},emits:["edit","delete","toggleStatus","trigger"],setup(i){const n=({row:l})=>l.isActive?"":"opacity-60",o=l=>l||"-",c=l=>{if(!l)return"-";try{return ue(new Date(l),"yyyy-MM-dd HH:mm")}catch(r){return console.error("Error formatting date:",l,r),l}};return(l,r)=>{const f=_("el-table-column"),x=_("el-tag"),v=_("el-button"),S=_("el-tooltip"),b=_("el-empty"),$=_("el-table"),u=ee("loading");return C(),M("div",ge,[te((C(),E($,{data:i.configs,style:{width:"100%"},"row-key":"configId","row-class-name":n},{empty:a(()=>[t(b,{description:"暂无配置数据"})]),default:a(()=>[t(f,{prop:"targetName",label:"配置名称","min-width":"180"},{default:a(({row:p})=>[m("span",me,P(p.targetName),1)]),_:1}),t(f,{prop:"targetType",label:"目标类型","min-width":"100"},{default:a(({row:p})=>[t(oe,{type:p.targetType},null,8,["type"])]),_:1}),t(f,{prop:"extractionStrategyType",label:"提取策略","min-width":"100"},{default:a(({row:p})=>[t(pe,{type:p.extractionStrategyType},null,8,["type"])]),_:1}),t(f,{prop:"triggerSchedule",label:"计划","min-width":"120"},{default:a(({row:p})=>[m("span",null,P(o(p.triggerSchedule)),1)]),_:1}),t(f,{prop:"isActive",label:"状态","min-width":"100"},{default:a(({row:p})=>[t(x,{type:p.isActive?"success":"info",size:"small"},{default:a(()=>[A(P(p.isActive?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(f,{prop:"updateTime",label:"更新时间","min-width":"160"},{default:a(({row:p})=>[m("span",null,P(c(p.updateTime)),1)]),_:1}),t(f,{label:"操作",width:"160",fixed:"right"},{default:a(({row:p})=>[m("div",fe,[t(S,{content:"编辑",placement:"top"},{default:a(()=>[t(v,{link:"",type:"primary",onClick:s=>l.$emit("edit",p),class:"p-1 text-xs"},{default:a(()=>r[0]||(r[0]=[m("i",{class:"fas fa-edit"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),t(S,{content:"删除",placement:"top"},{default:a(()=>[t(v,{link:"",type:"danger",onClick:s=>l.$emit("delete",p.configId),class:"p-1 text-xs"},{default:a(()=>r[1]||(r[1]=[m("i",{class:"fas fa-trash"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),t(S,{content:p.isActive?"禁用":"启用",placement:"top"},{default:a(()=>[t(v,{link:"",type:p.isActive?"warning":"success",onClick:s=>l.$emit("toggleStatus",p.configId,!p.isActive),class:"p-1 text-xs"},{default:a(()=>[m("i",{class:q(p.isActive?"fas fa-toggle-off":"fas fa-toggle-on")},null,2)]),_:2},1032,["type","onClick"])]),_:2},1032,["content"]),t(S,{content:"立即触发",placement:"top"},{default:a(()=>[t(v,{link:"",type:"info",onClick:s=>l.$emit("trigger",p.configId),disabled:!p.isActive,class:"p-1 text-xs"},{default:a(()=>r[2]||(r[2]=[m("i",{class:"fas fa-play-circle"},null,-1)])),_:2},1032,["onClick","disabled"])]),_:2},1024)])]),_:1})]),_:1},8,["data"])),[[u,i.loading]])])}}});function L(i){if(!i)return"{}";try{const n=typeof i=="string"?JSON.parse(i):i;return JSON.stringify(n,null,2)}catch(n){return console.error("JSON格式化失败:",n),"{}"}}function ye(i){if(!i||i.trim()===""||i.trim()==="{}")return!0;try{return JSON.parse(i),!0}catch{return!1}}function Y(i){if(!i)return"{}";if(typeof i=="string")try{return JSON.parse(i),i}catch{return"{}"}try{return JSON.stringify(i)}catch{return"{}"}}function _e(i){if(!i)return"{}";try{return JSON.parse(i),L(i)}catch{try{let o=i.replace(/'/g,'"');o=o.replace(/(\w+):/g,'"$1":');const c=JSON.parse(o);return L(c)}catch{return"{}"}}}const xe={class:"border-t pt-4 mt-4"},be={class:"relative w-full"},he={class:"absolute right-0 top-0 flex space-x-1 m-1"},we={class:"text-xs text-gray-400 mt-1"},Se={key:1,class:"mt-3 space-y-3"},Ce={class:"relative w-full"},Te={class:"absolute right-0 top-0 flex space-x-1 m-1"},Ue={class:"text-xs text-gray-400 mt-1"},ke={class:"border-t pt-4 mt-4"},Ne={class:"relative w-full"},Ae={class:"absolute right-0 top-0 flex space-x-1 m-1"},Pe={class:"text-xs text-gray-400 mt-1"},Ie={class:"modal-footer"},$e={class:"json-example-content"},Oe={class:"dialog-footer"},Ee='{ "baseSelector": "article.post", "fields": [ { "name": "title", "selector": "h1", "type": "text" } ] }',Ve='{ "title": "Data", "type": "object", "properties": { ... } }',Me=D({__name:"ConfigModal",props:{visible:{type:Boolean,required:!0},mode:{type:String,required:!0},initialData:{type:Object,default:null}},emits:["update:visible","save","close"],setup(i,{emit:n}){const o=i,c=n,l=V(()=>o.mode==="edit"),r=U(!1),f=U(""),x=U(""),v=U(""),S=y=>{v.value=y,y==="extractionSchema"?s.value.extractionStrategyType==="css"?(f.value="CSS提取Schema示例",x.value=L({title:".news-item .news-title",publishTime:".news-item .news-time",source:".news-item .news-source",content:".news-content",author:".author-info"})):(f.value="LLM提取Schema示例",x.value=L({type:"object",properties:{title:{type:"string"},content:{type:"string"},publishTime:{type:"string"},source:{type:"string"}}})):y==="llmProviderConfig"?(f.value="LLM模型配置示例",x.value=L({provider:"dashscope",model:"qwen-max",temperature:.1,max_tokens:1e3})):y==="crawl4aiConfigOverride"&&(f.value="Crawl4AI配置覆盖示例",x.value=L({wait_for:".article-content",timeout:3e4,retry_count:3,user_agent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"})),r.value=!0},b=()=>{v.value&&s.value[v.value]!==void 0&&(s.value[v.value]=x.value),r.value=!1},$=y=>{if(s.value[y])try{const e=L(s.value[y]);s.value[y]=e,T.success("JSON格式化成功")}catch{try{const d=_e(s.value[y]);s.value[y]=d,T.warning("JSON格式有问题，已尝试修复")}catch{T.error("JSON格式无法修复，请检查语法")}}};X(()=>o.initialData,y=>{if(console.log("ConfigModal initialData changed:",y),o.visible&&y){console.log("ConfigModal initialData详细信息:",JSON.stringify(y));const e={...y,crawlDepth:y.crawlDepth!==void 0?Number(y.crawlDepth):0,extractionStrategyType:y.extractionStrategyType||"css",isActive:y.isActive!==void 0?y.isActive:!0,triggerSchedule:y.triggerSchedule||"0 0 * * * ?",extractionSchema:y.extractionSchema||"{}",llmProviderConfig:y.llmProviderConfig||"{}",crawl4aiConfigOverride:y.crawl4aiConfigOverride||"{}"};console.log("设置表单数据:",e),s.value={...e},H(()=>{var d;(d=u.value)==null||d.clearValidate()})}},{immediate:!0,deep:!0});const u=U(),p=U(!1);X(()=>o.visible,y=>{console.log("ConfigModal visibility changed:",y),y?o.initialData||(s.value={targetType:"policy",extractionStrategyType:"css",crawlDepth:0,isActive:!0,targetName:void 0,sourceUrls:void 0,triggerSchedule:"0 0 * * * ?",extractionSchema:"{}",llmInstruction:void 0,llmProviderConfig:"{}",crawl4aiConfigOverride:"{}"},console.log("FormData reset to defaults in visibility watch")):console.log("Modal closed, form data preserved")});const s=U({configId:void 0,targetName:void 0,targetType:"policy",sourceUrls:void 0,crawlDepth:0,triggerSchedule:"0 0 * * * ?",extractionStrategyType:"css",extractionSchema:"{}",llmInstruction:void 0,llmProviderConfig:"{}",crawl4aiConfigOverride:"{}",isActive:!0}),O=(y,e,d)=>{if(!e||e.trim()==="{}"){d();return}ye(e)?d():d(new Error("请输入有效的 JSON 格式"))},R=U({targetName:[{required:!0,message:"请输入配置名称",trigger:"blur"}],targetType:[{required:!0,message:"请选择目标类型",trigger:"change"}],sourceUrls:[{required:!0,message:"请输入起始 URL (每行一个)",trigger:"blur"}],triggerSchedule:[{required:!0,message:"请输入执行计划 (Cron 格式)",trigger:"blur"}],extractionStrategyType:[{required:!0,message:"请选择提取策略类型",trigger:"change"}],extractionSchema:[{required:V(()=>s.value.extractionStrategyType==="css"||s.value.extractionStrategyType==="llm").value,message:V(()=>s.value.extractionStrategyType==="css"?"请输入 CSS 提取 Schema (JSON)":"请输入 LLM 提取 Schema (Pydantic/JSON)").value,trigger:"blur"},{validator:O,trigger:"blur"}],llmProviderConfig:[{required:V(()=>s.value.extractionStrategyType==="llm").value,message:"请输入 LLM 模型配置 (JSON)",trigger:"blur"},{validator:O,trigger:"blur"}],llmInstruction:[{required:V(()=>s.value.extractionStrategyType==="llm").value,message:"请输入 LLM 指令",trigger:"blur"}],crawl4aiConfigOverride:[{validator:O,trigger:"blur"}]});X(()=>s.value.extractionStrategyType,(y,e)=>{u.value&&H(()=>{var g,w,k,I;const d=["llmProviderConfig","llmInstruction"];e==="llm"&&y!=="llm"&&((g=u.value)==null||g.clearValidate(d)),(w=u.value)==null||w.validateField("extractionSchema").catch(N=>console.warn("Ignoring validation error during type switch for schema:",(N==null?void 0:N.message)||N)),y==="llm"&&((k=u.value)==null||k.validateField("llmProviderConfig").catch(N=>console.warn("Ignoring validation error during type switch for provider:",(N==null?void 0:N.message)||N)),(I=u.value)==null||I.validateField("llmInstruction").catch(N=>console.warn("Ignoring validation error during type switch for instruction:",(N==null?void 0:N.message)||N)))})});const J=()=>{c("update:visible",!1),c("close")},W=async()=>{if(u.value)try{if(await u.value.validate()){p.value=!0;const e={...s.value,crawlDepth:s.value.crawlDepth!==void 0?Number(s.value.crawlDepth):0};if("configId"in e&&delete e.configId,"createTime"in e&&delete e.createTime,"updateTime"in e&&delete e.updateTime,typeof e.sourceUrls=="string"){console.log("原始sourceUrls (前20个字符):",e.sourceUrls.substring(0,20)+(e.sourceUrls.length>20?"...":""));try{const g=e.sourceUrls.split(`
`);for(const w of g)w.trim().length>0&&w.length>500&&console.warn("发现异常长的URL:",w.substring(0,30)+"...")}catch(g){console.error("处理URL时出错:",g)}}const d=["extractionSchema","llmProviderConfig","crawl4aiConfigOverride"];for(const g of d)g==="extractionSchema"?e.extractionSchema=Y(e.extractionSchema):g==="llmProviderConfig"?e.llmProviderConfig=Y(e.llmProviderConfig):g==="crawl4aiConfigOverride"&&(e.crawl4aiConfigOverride=Y(e.crawl4aiConfigOverride));e.extractionStrategyType==="llm"&&!e.llmInstruction&&(e.llmInstruction="");try{const g={targetName:e.targetName,targetType:e.targetType,sourceUrlsLength:e.sourceUrls?e.sourceUrls.length:0,extractionStrategyType:e.extractionStrategyType,isActive:e.isActive};console.log("表单最终提交数据 (摘要):",g)}catch(g){console.error("打印数据摘要时出错:",g)}c("save",e)}else return T.error("请检查表单填写是否正确"),!1}catch(y){console.error("Form validation/submission error:",y)}finally{p.value=!1}};return(y,e)=>{const d=_("el-input"),g=_("el-form-item"),w=_("el-col"),k=_("el-option"),I=_("el-select"),N=_("el-row"),ne=_("el-input-number"),se=_("el-switch"),j=_("el-button"),Q=_("el-link"),re=_("el-form"),ae=_("el-dialog");return C(),E(ae,{"model-value":i.visible,title:l.value?"编辑爬虫配置":"新增爬虫配置",width:"800px","before-close":J,"custom-class":"crawler-config-modal","close-on-click-modal":!1,"append-to-body":""},{footer:a(()=>[m("div",Ie,[t(j,{onClick:J,class:"!rounded-button"},{default:a(()=>e[27]||(e[27]=[A("取消")])),_:1}),t(j,{type:"primary",onClick:W,loading:p.value,class:"!rounded-button"},{default:a(()=>e[28]||(e[28]=[A("保存配置")])),_:1},8,["loading"])])]),default:a(()=>[t(re,{ref_key:"configFormRef",ref:u,model:s.value,rules:R.value,"label-position":"top",class:"space-y-4 modal-body"},{default:a(()=>[t(N,{gutter:16},{default:a(()=>[t(w,{span:12},{default:a(()=>[t(g,{label:"配置名称",prop:"targetName"},{default:a(()=>[t(d,{modelValue:s.value.targetName,"onUpdate:modelValue":e[0]||(e[0]=h=>s.value.targetName=h),placeholder:"请输入配置名称"},null,8,["modelValue"])]),_:1})]),_:1}),t(w,{span:12},{default:a(()=>[t(g,{label:"目标类型",prop:"targetType"},{default:a(()=>[t(I,{modelValue:s.value.targetType,"onUpdate:modelValue":e[1]||(e[1]=h=>s.value.targetType=h),placeholder:"请选择目标类型",class:"w-full"},{default:a(()=>[t(k,{label:"政策",value:"policy"}),t(k,{label:"竞品",value:"competitor"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(g,{label:"起始 URL (每行一个)",prop:"sourceUrls"},{default:a(()=>[t(d,{modelValue:s.value.sourceUrls,"onUpdate:modelValue":e[2]||(e[2]=h=>s.value.sourceUrls=h),type:"textarea",rows:3,placeholder:"https://..."},null,8,["modelValue"])]),_:1}),t(N,{gutter:16},{default:a(()=>[t(w,{span:12},{default:a(()=>[t(g,{label:"执行计划 (Cron)",prop:"triggerSchedule"},{default:a(()=>[t(d,{modelValue:s.value.triggerSchedule,"onUpdate:modelValue":e[3]||(e[3]=h=>s.value.triggerSchedule=h),placeholder:"例如: 0 0 * * * ? (每小时)"},null,8,["modelValue"])]),_:1})]),_:1}),t(w,{span:12},{default:a(()=>[t(g,{label:"抓取深度 (可选)",prop:"crawlDepth"},{default:a(()=>[t(ne,{modelValue:s.value.crawlDepth,"onUpdate:modelValue":e[4]||(e[4]=h=>s.value.crawlDepth=h),min:0,placeholder:"0表示只抓取起始URL"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(g,{label:"是否启用",prop:"isActive"},{default:a(()=>[t(se,{modelValue:s.value.isActive,"onUpdate:modelValue":e[5]||(e[5]=h=>s.value.isActive=h)},null,8,["modelValue"])]),_:1}),m("div",xe,[e[23]||(e[23]=m("h5",{class:"text-base font-medium text-gray-700 mb-3"},"提取策略",-1)),t(g,{label:"策略类型",prop:"extractionStrategyType"},{default:a(()=>[t(I,{modelValue:s.value.extractionStrategyType,"onUpdate:modelValue":e[6]||(e[6]=h=>s.value.extractionStrategyType=h),placeholder:"请选择策略类型",class:"w-full md:w-1/2"},{default:a(()=>[t(k,{label:"CSS 选择器",value:"css"}),t(k,{label:"LLM 模型",value:"llm"})]),_:1},8,["modelValue"])]),_:1}),s.value.extractionStrategyType==="css"||s.value.extractionStrategyType==="llm"?(C(),E(g,{key:0,label:s.value.extractionStrategyType==="css"?"提取 Schema (JSON - CSS)":"提取 Schema (Pydantic/JSON Schema)",prop:"extractionSchema",class:"w-full"},{default:a(()=>[m("div",be,[t(d,{modelValue:s.value.extractionSchema,"onUpdate:modelValue":e[7]||(e[7]=h=>s.value.extractionSchema=h),type:"textarea",rows:6,placeholder:s.value.extractionStrategyType==="css"?Ee:Ve,class:"font-mono text-xs w-full"},null,8,["modelValue","placeholder"]),m("div",he,[t(j,{type:"primary",size:"small",onClick:e[8]||(e[8]=h=>$("extractionSchema")),class:"!rounded-button text-xs",disabled:!s.value.extractionSchema},{default:a(()=>e[19]||(e[19]=[A(" 格式化 ")])),_:1},8,["disabled"])])]),m("p",we,[t(Q,{type:"primary",onClick:e[9]||(e[9]=h=>S("extractionSchema")),class:"text-xs"},{default:a(()=>e[20]||(e[20]=[A("查看示例")])),_:1})])]),_:1},8,["label"])):F("",!0),s.value.extractionStrategyType==="llm"?(C(),M("div",Se,[t(g,{label:"LLM 模型配置 (JSON, 可选)",prop:"llmProviderConfig",class:"w-full"},{default:a(()=>[m("div",Ce,[t(d,{modelValue:s.value.llmProviderConfig,"onUpdate:modelValue":e[10]||(e[10]=h=>s.value.llmProviderConfig=h),type:"textarea",rows:3,placeholder:'{ "provider": "openai", "model": "gpt-4o-mini", /* "api_key_env": "MY_API_KEY" */ }',class:"font-mono text-xs w-full"},null,8,["modelValue"]),m("div",Te,[t(j,{type:"primary",size:"small",onClick:e[11]||(e[11]=h=>$("llmProviderConfig")),class:"!rounded-button text-xs",disabled:!s.value.llmProviderConfig},{default:a(()=>e[21]||(e[21]=[A(" 格式化 ")])),_:1},8,["disabled"])])]),m("p",Ue,[t(Q,{type:"primary",onClick:e[12]||(e[12]=h=>S("llmProviderConfig")),class:"text-xs"},{default:a(()=>e[22]||(e[22]=[A("查看示例")])),_:1})])]),_:1}),t(g,{label:"LLM 指令",prop:"llmInstruction",class:"w-full"},{default:a(()=>[t(d,{modelValue:s.value.llmInstruction,"onUpdate:modelValue":e[13]||(e[13]=h=>s.value.llmInstruction=h),type:"textarea",rows:3,placeholder:"例如: Extract title and summary.",class:"w-full"},null,8,["modelValue"])]),_:1})])):F("",!0)]),m("div",ke,[t(g,{label:"Crawl4AI 高级配置覆盖 (JSON, 可选)",prop:"crawl4aiConfigOverride",class:"w-full"},{default:a(()=>[m("div",Ne,[t(d,{modelValue:s.value.crawl4aiConfigOverride,"onUpdate:modelValue":e[14]||(e[14]=h=>s.value.crawl4aiConfigOverride=h),type:"textarea",rows:4,placeholder:'{ /* 例如: "wait_for": ".article-body" */ }',class:"font-mono text-xs w-full"},null,8,["modelValue"]),m("div",Ae,[t(j,{type:"primary",size:"small",onClick:e[15]||(e[15]=h=>$("crawl4aiConfigOverride")),class:"!rounded-button text-xs",disabled:!s.value.crawl4aiConfigOverride},{default:a(()=>e[24]||(e[24]=[A(" 格式化 ")])),_:1},8,["disabled"])])]),m("p",Pe,[e[26]||(e[26]=A(" 用于覆盖 CrawlerRunConfig 的默认参数，请谨慎使用。 ")),t(Q,{type:"primary",onClick:e[16]||(e[16]=h=>S("crawl4aiConfigOverride")),class:"text-xs"},{default:a(()=>e[25]||(e[25]=[A("查看示例")])),_:1})])]),_:1})])]),_:1},8,["model","rules"]),t(ae,{modelValue:r.value,"onUpdate:modelValue":e[18]||(e[18]=h=>r.value=h),title:f.value,width:"600px","append-to-body":"","custom-class":"json-example-dialog"},{footer:a(()=>[m("div",Oe,[t(j,{onClick:b,type:"primary",class:"!rounded-button"},{default:a(()=>e[29]||(e[29]=[A("应用此示例")])),_:1}),t(j,{onClick:e[17]||(e[17]=h=>r.value=!1),class:"!rounded-button"},{default:a(()=>e[30]||(e[30]=[A("关闭")])),_:1})])]),default:a(()=>[m("pre",$e,P(x.value),1)]),_:1},8,["modelValue","title"])]),_:1},8,["model-value","title"])}}});const B=Y;async function Le(i){return z.get("/v1/admin/crawler/configs",{params:i})}async function De(i){return z.get(`/v1/admin/crawler/configs/${i}`)}async function ze(i){const n={...i};if("configId"in n&&delete n.configId,"createTime"in n&&delete n.createTime,"updateTime"in n&&delete n.updateTime,"extractionSchema"in n&&(n.extractionSchema=B(n.extractionSchema)),"llmProviderConfig"in n&&(n.llmProviderConfig=B(n.llmProviderConfig)),"crawl4aiConfigOverride"in n&&(n.crawl4aiConfigOverride=B(n.crawl4aiConfigOverride)),typeof n.sourceUrls=="string")try{const o=n.sourceUrls.replace(/[\u0000-\u001F\u007F-\u009F]/g,"").trim();n.sourceUrls=o}catch(o){console.error("Failed to clean sourceUrls:",o)}return z.post("/v1/admin/crawler/configs",n)}async function Fe(i,n){const o={...n};if("configId"in o&&delete o.configId,"createTime"in o&&delete o.createTime,"updateTime"in o&&delete o.updateTime,"extractionSchema"in o&&(o.extractionSchema=B(o.extractionSchema)),"llmProviderConfig"in o&&(o.llmProviderConfig=B(o.llmProviderConfig)),"crawl4aiConfigOverride"in o&&(o.crawl4aiConfigOverride=B(o.crawl4aiConfigOverride)),typeof o.sourceUrls=="string")try{const c=o.sourceUrls.replace(/[\u0000-\u001F\u007F-\u009F]/g,"").trim();o.sourceUrls=c}catch(c){console.error("Failed to clean sourceUrls:",c)}return z.put(`/v1/admin/crawler/configs/${i}`,o)}async function Re(i){return z.delete(`/v1/admin/crawler/configs/${i}`)}async function Je(i,n){return z.patch(`/v1/admin/crawler/configs/${i}/status`,null,{params:{isActive:n}})}async function je(i){return z.post(`/v1/admin/crawler/configs/${i}/trigger`)}function Be(i){return z.get("/v1/admin/crawler/tasks",{params:i})}async function qe(i){const n={pageNum:i.pageNum,pageSize:i.pageSize,status:i.status,suggestionType:i.type};return z.get("/v1/admin/crawler/suggestions",{params:n})}async function We(i,n,o){const c={handlerId:n};return o&&(c.remarks=o),z.post(`/v1/admin/crawler/suggestions/${i}/approve`,null,{params:c})}async function Ye(i,n,o){return z.post(`/v1/admin/crawler/suggestions/${i}/reject`,null,{params:{handlerId:n,remarks:o}})}const He={class:"flex justify-between items-center mb-4"},Ge=D({__name:"ConfigManagementTab",setup(i,{expose:n}){const o=U(!1),c=U([]),l=G({pageNum:1,pageSize:10,keyword:void 0,targetType:void 0,isActive:void 0}),r=G({total:0,currentPage:1,pageSize:10}),f=U(!1),x=U("add"),v=U(null),S=async()=>{o.value=!0,l.pageNum=r.currentPage,l.pageSize=r.pageSize;try{const e=await Le(l);c.value=e.list,r.total=e.total}catch(e){console.error("Failed to fetch configs:",e),T.error((e==null?void 0:e.message)||(e==null?void 0:e.msg)||"获取配置列表时发生错误")}finally{o.value=!1}};le(()=>{S()});const b=()=>{x.value="add",v.value=null,f.value=!0},$=e=>{console.log("openAddModalWithData called with data:",e),x.value="add",f.value=!0,H(()=>{const d=typeof e.sourceUrls=="string"?e.sourceUrls:Array.isArray(e.sourceUrls)?e.sourceUrls.join(`
`):"",g={llmProviderConfig:e.llmProviderConfig||{},extractionSchema:e.extractionSchema||{},crawl4aiConfigOverride:e.crawl4aiConfigOverride||{}};Object.keys(g).forEach(k=>{g[k]=L(g[k])});const w={targetName:e.targetName||"",targetType:e.targetType||"policy",sourceUrls:d,extractionStrategyType:e.extractionStrategyType||"css",extractionSchema:g.extractionSchema,isActive:e.isActive!==void 0?e.isActive:!0,triggerSchedule:e.triggerSchedule||"0 0 * * * ?",crawlDepth:e.crawlDepth!==void 0?e.crawlDepth:0,crawl4aiConfigOverride:g.crawl4aiConfigOverride,llmProviderConfig:g.llmProviderConfig};e.extractionStrategyType==="llm"&&(w.llmInstruction=e.llmInstruction||""),v.value=w,console.log("Modal should be visible now. modalVisible =",f.value),console.log("Current config set to:",v.value)})},u=async e=>{o.value=!0;try{const d=await De(e.configId);x.value="edit",v.value=d,f.value=!0}catch(d){console.error("Failed to fetch config details:",d),T.error((d==null?void 0:d.message)||(d==null?void 0:d.msg)||"获取配置详情失败")}finally{o.value=!1}},p=()=>{f.value=!1,v.value=null},s=async e=>{const d=x.value==="add",g={...e};["configId","createTime","updateTime"].forEach(I=>{I in g&&(delete g[I],console.log(`已移除字段: ${I}`))}),g.extractionStrategyType!=="llm"&&delete g.llmInstruction,typeof g.sourceUrls=="string"&&g.sourceUrls&&console.log("保存前的sourceUrls:",g.sourceUrls);try{console.log("提交的配置数据:",g)}catch(I){console.error("提交的配置数据无法打印:",I)}const k=d?ze(g):Fe(v.value.configId,g);try{await k,T.success(d?"配置已创建":"配置已更新"),f.value=!1,await S()}catch(I){console.error("Failed to save config:",I),T.error(`保存失败: ${I}`)}},O=e=>{const d=c.value.find(w=>w.configId===e),g=d?`确定要删除配置 "${d.targetName}" 吗？`:"确定要删除此配置吗？";Z.confirm(g,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",customClass:"!rounded-button"}).then(async()=>{o.value=!0;try{await Re(e),T.success("删除成功"),S()}catch(w){console.error("Failed to delete config:",w),T.error((w==null?void 0:w.message)||(w==null?void 0:w.msg)||"删除失败")}finally{o.value=!1}}).catch(()=>{})},R=async(e,d)=>{o.value=!0;try{await Je(e,d),T.success("状态更新成功"),S()}catch(g){console.error("Failed to toggle config status:",g),T.error((g==null?void 0:g.message)||(g==null?void 0:g.msg)||"状态更新失败")}finally{o.value=!1}},J=async e=>{o.value=!0;try{await je(e),T.success("任务已触发（已发送到队列）")}catch(d){console.error("Failed to trigger config task:",d),T.error((d==null?void 0:d.message)||(d==null?void 0:d.msg)||"触发任务失败")}finally{o.value=!1}},W=e=>{r.pageSize=e,r.currentPage=1,S()},y=e=>{r.currentPage=e,S()};return n({openAddModalWithData:$}),(e,d)=>{const g=_("el-button"),w=_("el-pagination");return C(),M("div",null,[m("div",He,[d[4]||(d[4]=m("h3",{class:"text-lg font-semibold text-gray-700"},"爬虫配置列表",-1)),t(g,{type:"primary",onClick:b,class:"!rounded-button"},{default:a(()=>d[3]||(d[3]=[m("i",{class:"fas fa-plus mr-2"},null,-1),A("新增配置 ")])),_:1})]),t(ve,{configs:c.value,loading:o.value,onEdit:u,onDelete:O,onToggleStatus:R,onTrigger:J},null,8,["configs","loading"]),r.total>0?(C(),E(w,{key:0,class:"mt-4 justify-end",background:"",layout:"total, sizes, prev, pager, next, jumper",total:r.total,"page-sizes":[10,20,50,100],"page-size":r.pageSize,"onUpdate:pageSize":d[0]||(d[0]=k=>r.pageSize=k),"current-page":r.currentPage,"onUpdate:currentPage":d[1]||(d[1]=k=>r.currentPage=k),onSizeChange:W,onCurrentChange:y},null,8,["total","page-size","current-page"])):F("",!0),t(Me,{visible:f.value,"onUpdate:visible":d[2]||(d[2]=k=>f.value=k),mode:x.value,"initial-data":v.value,onSave:s,onClose:p},null,8,["visible","mode","initial-data"])])}}});const Ke=K(Ge,[["__scopeId","data-v-1cf86126"]]),Qe={class:"bg-white rounded-lg shadow-sm overflow-x-auto"},Xe={class:"font-mono"},Ze={class:"truncate max-w-xs inline-block"},et=D({__name:"TaskTable",props:{tasks:{type:Array,required:!0},loading:{type:Boolean,default:!1}},setup(i){return(n,o)=>{const c=_("el-table-column"),l=_("el-tooltip"),r=_("el-empty"),f=_("el-table"),x=ee("loading");return C(),M("div",Qe,[te((C(),E(f,{data:i.tasks,style:{width:"100%"},"row-key":"id"},{empty:a(()=>[t(r,{description:"暂无任务日志数据"})]),default:a(()=>[t(c,{prop:"id",label:"任务ID","min-width":"150"},{default:a(({row:v})=>[m("span",Xe,P(v.id),1)]),_:1}),t(c,{prop:"configName",label:"配置名称","min-width":"180"}),t(c,{prop:"targetUrl",label:"目标URL","min-width":"250"},{default:a(({row:v})=>[t(l,{content:v.targetUrl,placement:"top","show-after":500},{default:a(()=>[m("span",Ze,P(v.targetUrl),1)]),_:2},1032,["content"])]),_:1}),t(c,{prop:"startTime",label:"开始时间",width:"180"}),t(c,{prop:"endTime",label:"结束时间",width:"180"}),t(c,{prop:"status",label:"状态","min-width":"100"},{default:a(({row:v})=>[m("span",{class:q(v.status==="success"?"text-success":"text-danger")},P(v.status==="success"?"成功":"失败"),3)]),_:1}),t(c,{prop:"errorMessage",label:"错误信息","min-width":"200"},{default:a(({row:v})=>[t(l,{content:v.errorMessage||"-",placement:"top","show-after":500},{default:a(()=>[m("span",{class:q([{"text-danger":v.status==="failure"},"truncate max-w-xs inline-block"])},P(v.errorMessage||"-"),3)]),_:2},1032,["content"])]),_:1})]),_:1},8,["data"])),[[x,i.loading]])])}}});const tt={class:"flex justify-between items-center mb-4"},lt={class:"flex space-x-2"},at=D({__name:"TaskMonitoringTab",setup(i){const n=U(!1),o=U([]),c=U(0),l=U(null),r=G({pageNum:1,pageSize:10,status:void 0,startTime:void 0,endTime:void 0}),f=V(()=>{const u={...r};return l.value?(u.startTime=l.value[0],u.endTime=l.value[1]):(u.startTime=void 0,u.endTime=void 0),u}),x=async()=>{n.value=!0;try{const u=await Be(f.value);console.log("Response data from getCrawlerTaskLogs:",u),u&&u.list&&typeof u.total=="number"?(o.value=u.list,c.value=u.total):(console.error("Unexpected response data structure:",u),T.error("获取任务日志失败：响应数据格式不正确"),o.value=[],c.value=0)}catch(u){console.error("Failed to fetch task logs:",u),o.value=[],c.value=0}finally{n.value=!1}};le(()=>{x()});const v=()=>{r.pageNum=1,x()},S=u=>{r.pageSize=u,x()},b=u=>{r.pageNum=u,x()},$=async()=>{console.log("==== 测试API调用开始 ===="),console.log("查询参数:",f.value);try{const u=await fetch("/api/v1/admin/crawler/tasks?pageNum=1&pageSize=10",{method:"GET",headers:{"Content-Type":"application/json"}});console.log("API响应状态:",u.status);const p=await u.json();console.log("API响应数据:",p),p&&p.code===200&&p.data&&(console.log("API响应数据中的data部分:",p.data),console.log("data.list存在吗?",!!p.data.list),console.log("data.total存在吗?",typeof p.data.total=="number"))}catch(u){console.error("测试API调用失败:",u)}console.log("==== 测试API调用结束 ====")};return(u,p)=>{const s=_("el-date-picker"),O=_("el-option"),R=_("el-select"),J=_("el-button"),W=_("el-pagination");return C(),M("div",null,[m("div",tt,[p[4]||(p[4]=m("h3",{class:"text-lg font-semibold text-gray-700"},"任务执行监控",-1)),m("div",lt,[t(s,{modelValue:l.value,"onUpdate:modelValue":p[0]||(p[0]=y=>l.value=y),type:"datetimerange","range-separator":"至","start-placeholder":"开始日期时间","end-placeholder":"结束日期时间",class:"!rounded-button text-sm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"]),t(R,{modelValue:r.status,"onUpdate:modelValue":p[1]||(p[1]=y=>r.status=y),placeholder:"所有状态",clearable:"",class:"!rounded-button text-sm w-32"},{default:a(()=>[t(O,{label:"成功",value:"success"}),t(O,{label:"失败",value:"failure"})]),_:1},8,["modelValue"]),t(J,{type:"primary",onClick:v,loading:n.value,class:"!rounded-button"},{default:a(()=>p[2]||(p[2]=[A("查询")])),_:1},8,["loading"]),t(J,{type:"warning",onClick:$,class:"!rounded-button ml-2"},{default:a(()=>p[3]||(p[3]=[A("测试API")])),_:1})])]),t(et,{tasks:o.value,loading:n.value},null,8,["tasks","loading"]),c.value>0?(C(),E(W,{key:0,class:"mt-4 justify-end",background:"",layout:"total, sizes, prev, pager, next, jumper",total:c.value,"page-sizes":[10,20,50],"page-size":r.pageSize,"current-page":r.pageNum,onSizeChange:S,onCurrentChange:b},null,8,["total","page-size","current-page"])):F("",!0)])}}});const ot=K(at,[["__scopeId","data-v-d63f7c11"]]),nt=D({__name:"StatusTag",props:{status:{}},setup(i){const n=i,o=V(()=>{var r;const l=((r=n.status)==null?void 0:r.toUpperCase())||"";return l==="ENABLED"||l==="ENABLED"||l==="TRUE"?"bg-success/10 text-success":l==="DISABLED"||l==="DISABLED"||l==="FALSE"?"bg-gray-100 text-gray-600":l==="PENDING"?"bg-yellow-100 text-yellow-600":l==="APPROVED"?"bg-green-100 text-green-600":l==="REJECTED"?"bg-red-100 text-red-600":l==="SUCCESS"?"text-success":l==="FAILURE"?"text-danger":"bg-gray-100 text-gray-600"}),c=V(()=>{var r;const l=((r=n.status)==null?void 0:r.toUpperCase())||"";return l==="ENABLED"||l==="ENABLED"||l==="TRUE"?"启用":l==="DISABLED"||l==="DISABLED"||l==="FALSE"?"禁用":l==="PENDING"?"待处理":l==="APPROVED"?"已采纳":l==="REJECTED"?"已拒绝":l==="SUCCESS"?"成功":l==="FAILURE"?"失败":n.status||"未知"});return(l,r)=>(C(),M("span",{class:q([o.value,"px-2 py-1 text-xs font-medium rounded-full whitespace-nowrap"])},P(c.value),3))}});const st=K(nt,[["__scopeId","data-v-6b920678"]]),rt={class:"bg-white rounded-lg shadow-sm overflow-x-auto"},it={class:"truncate max-w-xs inline-block"},ct={class:"space-x-1 whitespace-nowrap"},ut=D({__name:"SuggestionTable",props:{suggestions:{type:Array,required:!0},loading:{type:Boolean,default:!1}},emits:["approve","reject"],setup(i){function n(o){if(!o)return"-";try{const c=new Date(o);if(isNaN(c.getTime()))return"-";const l=c.getFullYear(),r=(c.getMonth()+1).toString().padStart(2,"0"),f=c.getDate().toString().padStart(2,"0"),x=c.getHours().toString().padStart(2,"0"),v=c.getMinutes().toString().padStart(2,"0"),S=c.getSeconds().toString().padStart(2,"0");return`${l}-${r}-${f} ${x}:${v}:${S}`}catch(c){return console.error("Error formatting date-time:",c),"-"}}return(o,c)=>{const l=_("el-table-column"),r=_("el-tooltip"),f=_("el-button"),x=_("el-empty"),v=_("el-table"),S=ee("loading");return C(),M("div",rt,[te((C(),E(v,{data:i.suggestions,style:{width:"100%"},"row-key":"id"},{empty:a(()=>[t(x,{description:"暂无用户建议数据"})]),default:a(()=>[t(l,{prop:"userId",label:"建议用户ID","min-width":"100"}),t(l,{prop:"createdAt",label:"建议时间",width:"180"},{default:a(({row:b})=>[m("span",null,P(n(b.createdAt)),1)]),_:1}),t(l,{prop:"suggestionType",label:"类型",width:"100"},{default:a(({row:b})=>[t(oe,{type:b.suggestionType||""},null,8,["type"])]),_:1}),t(l,{prop:"sourceName",label:"建议名称","min-width":"150"}),t(l,{prop:"suggestionUrl",label:"建议URL","min-width":"200"},{default:a(({row:b})=>[t(r,{content:b.suggestionUrl,placement:"top","show-after":500},{default:a(()=>[m("span",it,P(b.suggestionUrl),1)]),_:2},1032,["content"])]),_:1}),t(l,{prop:"remarks",label:"理由","min-width":"180"},{default:a(({row:b})=>[m("span",null,P(b.remarks),1)]),_:1}),t(l,{prop:"status",label:"状态","min-width":"100"},{default:a(({row:b})=>[t(st,{status:b.status},null,8,["status"])]),_:1}),t(l,{label:"操作",width:"140",fixed:"right"},{default:a(({row:b})=>[m("div",ct,[b.status&&b.status.toUpperCase()==="PENDING"?(C(),M(ie,{key:0},[t(r,{content:"采纳并配置",placement:"top"},{default:a(()=>[t(f,{link:"",type:"primary",onClick:$=>o.$emit("approve",b),class:"p-1 text-xs"},{default:a(()=>c[0]||(c[0]=[m("i",{class:"fas fa-check"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024),t(r,{content:"拒绝",placement:"top"},{default:a(()=>[t(f,{link:"",type:"danger",onClick:$=>o.$emit("reject",b),class:"p-1 text-xs"},{default:a(()=>c[1]||(c[1]=[m("i",{class:"fas fa-times"},null,-1)])),_:2},1032,["onClick"])]),_:2},1024)],64)):b.status&&b.status.toUpperCase()==="APPROVED"?(C(),E(r,{key:1,content:"已处理",placement:"top"},{default:a(()=>[t(f,{link:"",disabled:"",class:"p-1 text-gray-400 cursor-not-allowed text-xs"},{default:a(()=>c[2]||(c[2]=[m("i",{class:"fas fa-check-double"},null,-1)])),_:1})]),_:1})):b.status&&b.status.toUpperCase()==="REJECTED"?(C(),E(r,{key:2,content:"已处理",placement:"top"},{default:a(()=>[t(f,{link:"",disabled:"",class:"p-1 text-gray-400 cursor-not-allowed text-xs"},{default:a(()=>c[3]||(c[3]=[m("i",{class:"fas fa-ban"},null,-1)])),_:1})]),_:1})):F("",!0)])]),_:1})]),_:1},8,["data"])),[[S,i.loading]])])}}});const dt=D({__name:"UserSuggestionsTab",emits:["approve","reject","show-config-modal"],setup(i,{emit:n}){ce();const o=n,c=U(!1),l=U([]),r=U(0),f=G({pageNum:1,pageSize:10}),x=async()=>{c.value=!0;try{const u=await qe(f);console.log("Received suggestions data:",u),u&&u.list?(l.value=u.list,r.value=u.total||0,console.log("Parsed suggestions:",l.value)):(console.error("Unexpected API response format:",u),l.value=[],r.value=0)}catch(u){console.error("Failed to fetch suggestions:",u),T.error((u==null?void 0:u.message)||"获取用户建议时发生错误"),l.value=[],r.value=0}finally{c.value=!1}};le(()=>{x()});const v=u=>{Z.confirm(`确定要采纳 "${u.sourceName}" 建议吗？采纳后将跳转到配置页面。`,"确认采纳",{confirmButtonText:"确定并配置",cancelButtonText:"取消",type:"info",customClass:"!rounded-button"}).then(async()=>{c.value=!0;try{await We(u.id.toString(),1),T.success("建议已采纳，正在配置...");let s="";if(u.suggestionUrl)try{s=new URL(u.suggestionUrl).toString(),console.log("采纳的URL已标准化:",s)}catch{console.warn("采纳的URL格式可能不正确:",u.suggestionUrl),s=u.suggestionUrl}const O={targetName:u.sourceName,targetType:u.suggestionType==="NEW_SOURCE_POLICY"?"policy":"competitor",sourceUrls:s,isActive:!0,extractionStrategyType:"css",crawlDepth:0,extractionSchema:L({}),llmProviderConfig:L({}),llmInstruction:"",crawl4aiConfigOverride:L({}),triggerSchedule:"0 0 * * * ?"};console.log("准备发送show-config-modal事件，targetName:",O.targetName),console.log("sourceUrls (截取):",O.sourceUrls.substring(0,30)+(O.sourceUrls.length>30?"...":"")),o("show-config-modal",O)}catch(p){console.error("Failed to approve suggestion:",p),T.error((p==null?void 0:p.message)||"采纳建议时发生错误")}finally{c.value=!1}}).catch(()=>{T.info("已取消操作")})},S=u=>{Z.prompt("请输入拒绝理由：","确认拒绝",{confirmButtonText:"确定拒绝",cancelButtonText:"取消",inputPattern:/\S+/,inputErrorMessage:"拒绝理由不能为空",type:"warning",customClass:"!rounded-button"}).then(async({value:p})=>{if(!p){T.warning("拒绝理由不能为空");return}c.value=!0;try{await Ye(u.id.toString(),1,p),T.info("建议已拒绝"),x()}catch(s){console.error("Failed to reject suggestion:",s),T.error((s==null?void 0:s.message)||"拒绝建议时发生错误")}finally{c.value=!1}}).catch(()=>{T.info("已取消拒绝")})},b=u=>{f.pageSize=u,x()},$=u=>{f.pageNum=u,x()};return(u,p)=>{const s=_("el-pagination");return C(),M("div",null,[p[0]||(p[0]=m("div",{class:"flex justify-between items-center mb-4"},[m("h3",{class:"text-lg font-semibold text-gray-700"},"用户建议审核")],-1)),t(ut,{suggestions:l.value,loading:c.value,onApprove:v,onReject:S},null,8,["suggestions","loading"]),r.value>0?(C(),E(s,{key:0,class:"mt-4 justify-end",background:"",layout:"total, sizes, prev, pager, next, jumper",total:r.value,"page-sizes":[10,20,50],"page-size":f.pageSize,"current-page":f.pageNum,onSizeChange:b,onCurrentChange:$},null,8,["total","page-size","current-page"])):F("",!0)])}}});const pt=K(dt,[["__scopeId","data-v-0d77584f"]]),gt={class:"max-w-[1440px] mx-auto px-6 pt-24 pb-12"},mt={class:"mt-6"},ft="/admin/crawler",bt=D({__name:"index",setup(i){const n=U("config"),o=U(null),c=U({name:"管理员",avatar:"",notifications:0}),l=f=>{},r=f=>{console.log("Parent received show-config-modal event with data:",f),n.value="config",H(()=>{o.value?(console.log("Calling openAddModalWithData on ConfigManagementTab"),o.value.openAddModalWithData(f)):console.error("ConfigManagementTab reference not found")})};return(f,x)=>{const v=_("el-tab-pane"),S=_("el-tabs");return C(),M("div",null,[t(de,{"active-menu":ft,user:c.value},null,8,["user"]),m("div",gt,[x[1]||(x[1]=m("h2",{class:"text-2xl font-semibold text-gray-800 mb-6"},"爬虫系统管理",-1)),t(S,{modelValue:n.value,"onUpdate:modelValue":x[0]||(x[0]=b=>n.value=b),class:"admin-crawler-tabs",onTabClick:l},{default:a(()=>[t(v,{label:"配置管理",name:"config"}),t(v,{label:"任务监控",name:"monitor"}),t(v,{label:"用户建议",name:"suggestions"})]),_:1},8,["modelValue"]),m("div",mt,[n.value==="config"?(C(),E(Ke,{key:0,ref_key:"configManagementTabRef",ref:o},null,512)):F("",!0),n.value==="monitor"?(C(),E(ot,{key:1})):F("",!0),n.value==="suggestions"?(C(),E(pt,{key:2,onShowConfigModal:r})):F("",!0)])])])}}});export{bt as default};
